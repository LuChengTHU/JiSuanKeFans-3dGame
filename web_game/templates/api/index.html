{% extends "base.html" %}

{% load bootstrap3 %}
{% load static %}
{% block title %}Hello{% endblock %}

{% block extra_head %}
<script src="{% static 'api/js/blockly/blockly_compressed.js' %}"></script>
<script src="{% static 'api/js/blockly/blocks_compressed.js' %}"></script>
<script src="{% static 'api/js/blockly/en.js' %}"></script>
<script src="{% static 'api/js/blockly/javascript_compressed.js' %}"></script>
<script src="{% static 'api/js/blockly/python_compressed.js' %}"></script>
<script src="{% static 'api/js/blockly/lua_compressed.js' %}"></script>
<script src="{% static 'api/js/blockly/php_compressed.js' %}"></script>
<script src="{% static 'api/js/blockly/custom.js' %}"></script>
<script src="{% static 'api/js/game/logic.js' %}"></script>
<script src="{% static 'api/js/utils/acorn_interpreter.js' %}"></script>
{% comment %} <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script> {% endcomment %}
<xml id="toolbox" style="display: none">
  <block type="game_move"></block>
  <block type="game_turn"></block>
  <block type="controls_if"></block>
  <block type="controls_repeat_ext"></block>
  <block type="logic_compare"></block>
  <block type="math_number"></block>
  <block type="math_arithmetic"></block>
  <block type="text"></block>
  <block type="text_print"></block>
</xml>
<xml xmlns="http://www.w3.org/1999/xhtml" id="workspaceBlocks" style="display:none">
  <variables></variables>
  <block type="controls_repeat_ext" id="XXW{mM|V)O4t}b%c`k=Y" x="13" y="13">
    <value name="TIMES">
      <shadow type="math_number" id="t6[VMer(7eCVqRMEX2ez">
        <field name="NUM">10</field>
      </shadow>
    </value>
    <statement name="DO">
      <block type="game_move" id="+!cL)/7;TB9NG)vuHr+;"></block>
    </statement>
  </block>
</xml>
{% endblock %}
{% block extra_script %}
<script>
  //var workspacePlayground = Blockly.inject('blocklyDiv',
      //{toolbox: document.getElementById('toolbox')});
      var workspace = Blockly.inject('blocklyDiv',
      {toolbox: document.getElementById('toolbox')});
  var defaultBlocks = document.getElementById('workspaceBlocks');
  Blockly.Xml.domToWorkspace(defaultBlocks, workspace);
  function myUpdateFunction(event) {
    var languageDropdown = document.getElementById('languageDropdown');
    var languageSelection = languageDropdown.options[languageDropdown.selectedIndex].value;
    var codeDiv = document.getElementById('codeDiv');
    var codeHolder = document.createElement('pre');
    codeHolder.className = 'prettyprint but-not-that-pretty';
    var code = document.createTextNode(Blockly[languageSelection].workspaceToCode(workspace));
    codeHolder.appendChild(code);
    codeDiv.replaceChild(codeHolder, codeDiv.lastElementChild);
    //PR.prettyPrint();
  }
  workspace.addChangeListener(myUpdateFunction);
  function executeBlockCode() {
    var code = Blockly.JavaScript.workspaceToCode(workspace);
    var initFunc = function(interpreter, scope) {
      var alertWrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(alert(text));
      };
      interpreter.setProperty(scope, 'alert',
          interpreter.createNativeFunction(alertWrapper));
      var promptWrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(prompt(text));
      };
      interpreter.setProperty(scope, 'prompt',
          interpreter.createNativeFunction(promptWrapper));
      var GameMove = function() {
        return interpreter.createPrimitive(Game.gameMove());
      };
      interpreter.setProperty(scope, 'gameMove',
          interpreter.createNativeFunction(GameMove));
      var GameTurn = function(x) {
        return interpreter.createPrimitive(Game.gameTurn(x));
      };
      interpreter.setProperty(scope, 'gameTurn',
          interpreter.createNativeFunction(GameTurn));
    };
    var myInterpreter = new Interpreter(code, initFunc);
    var stepsAllowed = 10000;
    while (myInterpreter.step() && stepsAllowed) {
      stepsAllowed--;
    }
    if (!stepsAllowed) {
      throw EvalError('Infinite loop.');
    }
  }
  
  document.getElementById('playButton').addEventListener('click', executeBlockCode);
</script>
{% endblock %}
{% block main %}
<div class="row">

  <div id="blocklyDiv" class="col-xs-6 col-sm-3" style="height: 480px; width: 600px;" ></div>
  {% comment %} <div id="blocklyDiv" class="main blockly-panel"></div> {% endcomment %}
  <div id="codeDiv" class="main output-panel">
    <div class="dropdown-bar">
      Language:
      <div id="im-just-an-underline">
        <select id="languageDropdown" onChange="myUpdateFunction();">
          <option value="JavaScript">JavaScript</option>
          <option value="Python">Python</option>
          <option value="PHP">PHP</option>
          <option value="Lua">Lua</option>
          <option value="Dart">Dart</option>
        </select>
      </div>
    </div>
    <hr class="POps">
    <pre></pre>
  </div>
  <div class="col-xs-12">
      <hr class="POps">
  <button type="button" id="playButton" class="btn-success">Play</div>
  </div>
</div>

{% endblock %}